<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECC Digital Signing System</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                    }
                }
            }
        }
    </script>
    <style>
        .file-upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .file-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        .file-upload-area.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Base URL
        const API_BASE = 'http://localhost:5000';

        // Notification Component
        const Notification = ({ type, message, onClose }) => {
            const bgColor = type === 'success' ? 'bg-success' : 
                           type === 'error' ? 'bg-danger' : 
                           type === 'warning' ? 'bg-warning' : 'bg-primary';
            
            useEffect(() => {
                const timer = setTimeout(() => onClose(), 5000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className={`fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md`}>
                    <div className="flex items-center justify-between">
                        <span>{message}</span>
                        <button onClick={onClose} className="ml-4 text-white hover:text-gray-200">
                            √ó
                        </button>
                    </div>
                </div>
            );
        };

        // File Upload Component
        const FileUpload = ({ onFileSelect, selectedFile, accept = "*/*" }) => {
            const fileInputRef = useRef(null);
            const [dragOver, setDragOver] = useState(false);

            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    onFileSelect(files[0]);
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setDragOver(true);
            };

            const handleDragLeave = () => {
                setDragOver(false);
            };

            return (
                <div
                    className={`file-upload-area p-8 text-center cursor-pointer rounded-lg ${dragOver ? 'drag-over' : ''}`}
                    onDrop={handleDrop}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onClick={() => fileInputRef.current?.click()}
                >
                    <input
                        ref={fileInputRef}
                        type="file"
                        accept={accept}
                        onChange={(e) => onFileSelect(e.target.files[0])}
                        className="hidden"
                    />
                    <div className="text-4xl mb-4">üìÅ</div>
                    {selectedFile ? (
                        <div>
                            <p className="text-lg font-medium text-gray-700">{selectedFile.name}</p>
                            <p className="text-sm text-gray-500">{(selectedFile.size / 1024).toFixed(2)} KB</p>
                        </div>
                    ) : (
                        <div>
                            <p className="text-lg font-medium text-gray-700">Drop file here or click to browse</p>
                            <p className="text-sm text-gray-500">Supports any file type</p>
                        </div>
                    )}
                </div>
            );
        };

        // Key Generation Component
        const KeyGeneration = ({ onNotification, onKeyGenerated }) => {
            const [keyId, setKeyId] = useState('');
            const [password, setPassword] = useState('');
            const [encrypt, setEncrypt] = useState(true);
            const [loading, setLoading] = useState(false);

            const generateKey = async () => {
                if (!keyId.trim()) {
                    onNotification('error', 'Please enter a key ID');
                    return;
                }

                setLoading(true);
                try {
                    const payload = {
                        key_id: keyId,
                        encrypt: encrypt
                    };

                    if (encrypt && password.trim()) {
                        payload.password = password;
                    }

                    const response = await fetch(`${API_BASE}/generate-keys`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.success) {
                        onNotification('success', `Key "${keyId}" generated successfully`);
                        setKeyId('');
                        setPassword('');
                        onKeyGenerated();
                    } else {
                        onNotification('error', result.error || 'Failed to generate key');
                    }
                } catch (error) {
                    onNotification('error', 'Network error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">üîë Generate ECC Key Pair</h2>
                    
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Key ID</label>
                            <input
                                type="text"
                                value={keyId}
                                onChange={(e) => setKeyId(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="Enter unique key identifier"
                            />
                        </div>

                        <div className="flex items-center space-x-3">
                            <input
                                type="checkbox"
                                id="encrypt"
                                checked={encrypt}
                                onChange={(e) => setEncrypt(e.target.checked)}
                                className="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded"
                            />
                            <label htmlFor="encrypt" className="text-sm font-medium text-gray-700">
                                Encrypt private key (recommended)
                            </label>
                        </div>

                        {encrypt && (
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="Enter password for encryption"
                                />
                            </div>
                        )}

                        <button
                            onClick={generateKey}
                            disabled={loading}
                            className="w-full bg-primary text-white py-3 rounded-lg hover:bg-secondary transition-colors disabled:opacity-50"
                        >
                            {loading ? 'Generating...' : 'Generate Key Pair'}
                        </button>
                    </div>
                </div>
            );
        };

        // File Signing Component
        const FileSigning = ({ keys, onNotification }) => {
            const [selectedFile, setSelectedFile] = useState(null);
            const [selectedKey, setSelectedKey] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [signatureData, setSignatureData] = useState(null);

            const signFile = async () => {
                if (!selectedFile || !selectedKey) {
                    onNotification('error', 'Please select a file and key');
                    return;
                }

                const keyData = keys[selectedKey];
                if (keyData?.encrypted && !password.trim()) {
                    onNotification('error', 'Password required for encrypted key');
                    return;
                }

                setLoading(true);
                try {
                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    formData.append('key_id', selectedKey);
                    if (password.trim()) {
                        formData.append('password', password);
                    }

                    const response = await fetch(`${API_BASE}/sign-file`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        onNotification('success', 'File signed successfully');
                        setSignatureData(result);
                    } else {
                        onNotification('error', result.error || 'Failed to sign file');
                    }
                } catch (error) {
                    onNotification('error', 'Network error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const downloadSignature = () => {
                if (!signatureData) return;
                
                const blob = new Blob([JSON.stringify(signatureData.signature_data, null, 2)], 
                    { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${selectedFile.name}.sig`;
                a.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">‚úçÔ∏è Sign File</h2>
                    
                    <div className="space-y-4">
                        <FileUpload onFileSelect={setSelectedFile} selectedFile={selectedFile} />

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Select Key</label>
                            <select
                                value={selectedKey}
                                onChange={(e) => setSelectedKey(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                            >
                                <option value="">Choose a key...</option>
                                {Object.entries(keys).map(([keyId, keyData]) => (
                                    <option key={keyId} value={keyId}>
                                        {keyId} {keyData.encrypted ? 'üîí' : 'üîì'}
                                    </option>
                                ))}
                            </select>
                        </div>

                        {selectedKey && keys[selectedKey]?.encrypted && (
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="Enter key password"
                                />
                            </div>
                        )}

                        <button
                            onClick={signFile}
                            disabled={loading || !selectedFile || !selectedKey}
                            className="w-full bg-success text-white py-3 rounded-lg hover:bg-green-600 transition-colors disabled:opacity-50"
                        >
                            {loading ? 'Signing...' : 'Sign File'}
                        </button>

                        {signatureData && (
                            <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                <h3 className="font-medium text-green-800 mb-2">Signature Created!</h3>
                                <p className="text-sm text-green-700">Signature ID: {signatureData.signature_id}</p>
                                <p className="text-sm text-green-700">File Hash: {signatureData.signature_data.file_hash}</p>
                                <button
                                    onClick={downloadSignature}
                                    className="mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors"
                                >
                                    Download Signature
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // File Verification Component
        const FileVerification = ({ keys, onNotification }) => {
            const [selectedFile, setSelectedFile] = useState(null);
            const [signatureFile, setSignatureFile] = useState(null);
            const [selectedKey, setSelectedKey] = useState('');
            const [loading, setLoading] = useState(false);
            const [verificationResult, setVerificationResult] = useState(null);

            const verifySignature = async () => {
                if (!selectedFile || !signatureFile) {
                    onNotification('error', 'Please select both file and signature');
                    return;
                }

                setLoading(true);
                try {
                    const signatureText = await signatureFile.text();
                    const signatureData = JSON.parse(signatureText);

                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    formData.append('signature_data', JSON.stringify(signatureData));
                    if (selectedKey) {
                        formData.append('key_id', selectedKey);
                    }

                    const response = await fetch(`${API_BASE}/verify-signature`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        setVerificationResult(result);
                        if (result.valid) {
                            onNotification('success', 'Signature verification successful');
                        } else {
                            onNotification('error', 'Signature verification failed');
                        }
                    } else {
                        onNotification('error', result.error || 'Failed to verify signature');
                    }
                } catch (error) {
                    onNotification('error', 'Network error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">‚úÖ Verify Signature</h2>
                    
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Original File</label>
                            <FileUpload onFileSelect={setSelectedFile} selectedFile={selectedFile} />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Signature File (.sig)</label>
                            <FileUpload 
                                onFileSelect={setSignatureFile} 
                                selectedFile={signatureFile}
                                accept=".sig,.json"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Key (Optional)</label>
                            <select
                                value={selectedKey}
                                onChange={(e) => setSelectedKey(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                            >
                                <option value="">Auto-detect from signature...</option>
                                {Object.entries(keys).map(([keyId, keyData]) => (
                                    <option key={keyId} value={keyId}>
                                        {keyId} {keyData.encrypted ? 'üîí' : 'üîì'}
                                    </option>
                                ))}
                            </select>
                        </div>

                        <button
                            onClick={verifySignature}
                            disabled={loading || !selectedFile || !signatureFile}
                            className="w-full bg-primary text-white py-3 rounded-lg hover:bg-secondary transition-colors disabled:opacity-50"
                        >
                            {loading ? 'Verifying...' : 'Verify Signature'}
                        </button>

                        {verificationResult && (
                            <div className={`mt-4 p-4 border rounded-lg ${
                                verificationResult.valid 
                                    ? 'bg-green-50 border-green-200' 
                                    : 'bg-red-50 border-red-200'
                            }`}>
                                <h3 className={`font-medium mb-2 ${
                                    verificationResult.valid ? 'text-green-800' : 'text-red-800'
                                }`}>
                                    {verificationResult.valid ? '‚úÖ Valid Signature' : '‚ùå Invalid Signature'}
                                </h3>
                                <p className={`text-sm ${
                                    verificationResult.valid ? 'text-green-700' : 'text-red-700'
                                }`}>
                                    {verificationResult.message}
                                </p>
                                {verificationResult.file_info && (
                                    <div className="mt-2 text-sm text-gray-600">
                                        <p>File: {verificationResult.file_info.filename}</p>
                                        <p>Size: {verificationResult.file_info.size} bytes</p>
                                        <p>Hash: {verificationResult.file_info.hash}</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Binary Patching Component
        const BinaryPatching = ({ keys, onNotification }) => {
            const [selectedFile, setSelectedFile] = useState(null);
            const [selectedKey, setSelectedKey] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);

            const patchBinary = async () => {
                if (!selectedFile || !selectedKey) {
                    onNotification('error', 'Please select a file and key');
                    return;
                }

                const keyData = keys[selectedKey];
                if (keyData?.encrypted && !password.trim()) {
                    onNotification('error', 'Password required for encrypted key');
                    return;
                }

                setLoading(true);
                try {
                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    formData.append('key_id', selectedKey);
                    if (password.trim()) {
                        formData.append('password', password);
                    }

                    const response = await fetch(`${API_BASE}/patch-binary`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `signed_${selectedFile.name}`;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        onNotification('success', 'Binary patched and download started');
                    } else {
                        const result = await response.json();
                        onNotification('error', result.error || 'Failed to patch binary');
                    }
                } catch (error) {
                    onNotification('error', 'Network error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">üîß Patch Binary with Signature</h2>
                    
                    <div className="space-y-4">
                        <FileUpload onFileSelect={setSelectedFile} selectedFile={selectedFile} />

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Select Key</label>
                            <select
                                value={selectedKey}
                                onChange={(e) => setSelectedKey(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                            >
                                <option value="">Choose a key...</option>
                                {Object.entries(keys).map(([keyId, keyData]) => (
                                    <option key={keyId} value={keyId}>
                                        {keyId} {keyData.encrypted ? 'üîí' : 'üîì'}
                                    </option>
                                ))}
                            </select>
                        </div>

                        {selectedKey && keys[selectedKey]?.encrypted && (
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="Enter key password"
                                />
                            </div>
                        )}

                        <button
                            onClick={patchBinary}
                            disabled={loading || !selectedFile || !selectedKey}
                            className="w-full bg-warning text-white py-3 rounded-lg hover:bg-yellow-600 transition-colors disabled:opacity-50"
                        >
                            {loading ? 'Patching...' : 'Patch Binary & Download'}
                        </button>

                        <div className="text-sm text-gray-600 bg-yellow-50 p-3 rounded-lg">
                            <p className="font-medium">‚ÑπÔ∏è What is Binary Patching?</p>
                            <p>This embeds the signature directly into the file, creating a self-contained signed binary that can be verified without a separate signature file.</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Patched Binary Verification Component
        const PatchedBinaryVerification = ({ onNotification }) => {
            const [selectedFile, setSelectedFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [verificationResult, setVerificationResult] = useState(null);

            const verifyPatchedBinary = async () => {
                if (!selectedFile) {
                    onNotification('error', 'Please select a signed binary file');
                    return;
                }

                setLoading(true);
                try {
                    const formData = new FormData();
                    formData.append('file', selectedFile);

                    const response = await fetch(`${API_BASE}/verify-patched-binary`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        setVerificationResult(result);
                        if (result.valid) {
                            onNotification('success', 'Patched binary verification successful');
                        } else {
                            onNotification('error', 'Patched binary verification failed');
                        }
                    } else {
                        onNotification('error', result.error || 'Failed to verify patched binary');
                    }
                } catch (error) {
                    onNotification('error', 'Network error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">üîç Verify Patched Binary</h2>
                    
                    <div className="space-y-4">
                        <FileUpload onFileSelect={setSelectedFile} selectedFile={selectedFile} />

                        <button
                            onClick={verifyPatchedBinary}
                            disabled={loading || !selectedFile}
                            className="w-full bg-primary text-white py-3 rounded-lg hover:bg-secondary transition-colors disabled:opacity-50"
                        >
                            {loading ? 'Verifying...' : 'Verify Patched Binary'}
                        </button>

                        {verificationResult && (
                            <div className={`mt-4 p-4 border rounded-lg ${
                                verificationResult.valid 
                                    ? 'bg-green-50 border-green-200' 
                                    : 'bg-red-50 border-red-200'
                            }`}>
                                <h3 className={`font-medium mb-2 ${
                                    verificationResult.valid ? 'text-green-800' : 'text-red-800'
                                }`}>
                                    {verificationResult.valid ? '‚úÖ Valid Signed Binary' : '‚ùå Invalid Signed Binary'}
                                </h3>
                                <p className={`text-sm mb-3 ${
                                    verificationResult.valid ? 'text-green-700' : 'text-red-700'
                                }`}>
                                    {verificationResult.message}
                                </p>
                                
                                {verificationResult.signature_info && (
                                    <div className="text-sm text-gray-700 space-y-1">
                                        <p><strong>Algorithm:</strong> {verificationResult.signature_info.algorithm}</p>
                                        <p><strong>Key ID:</strong> {verificationResult.signature_info.key_id}</p>
                                        <p><strong>Timestamp:</strong> {new Date(verificationResult.signature_info.timestamp).toLocaleString()}</p>
                                        <p><strong>File Hash:</strong> {verificationResult.signature_info.file_hash}</p>
                                    </div>
                                )}
                                
                                {verificationResult.file_info && (
                                    <div className="mt-3 text-sm text-gray-600 bg-gray-50 p-2 rounded">
                                        <p><strong>Original Size:</strong> {verificationResult.file_info.original_size} bytes</p>
                                        <p><strong>Patched Size:</strong> {verificationResult.file_info.patched_size} bytes</p>
                                        <p><strong>Signature Overhead:</strong> {verificationResult.file_info.signature_size} bytes</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Key Management Component
        const KeyManagement = ({ keys, onKeyUpdated, onNotification }) => {
            const [showExportModal, setShowExportModal] = useState(false);
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [selectedKeyForAction, setSelectedKeyForAction] = useState('');
            const [exportFormat, setExportFormat] = useState('pem');
            const [exportPassword, setExportPassword] = useState('');
            const [oldPassword, setOldPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [loading, setLoading] = useState(false);

            const exportKey = async () => {
                if (!selectedKeyForAction) return;

                setLoading(true);
                try {
                    const payload = {
                        key_id: selectedKeyForAction,
                        format: exportFormat
                    };

                    if (exportFormat === 'pem' && exportPassword.trim()) {
                        payload.password = exportPassword;
                    }

                    const response = await fetch(`${API_BASE}/export-key`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.success) {
                        const blob = new Blob([JSON.stringify(result, null, 2)], 
                            { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${selectedKeyForAction}_export.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        onNotification('success', 'Key exported successfully');
                        setShowExportModal(false);
                        setExportPassword('');
                    } else {
                        onNotification('error', result.error || 'Failed to export key');
                    }
                } catch (error) {
                    onNotification('error', 'Network error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const changePassword = async () => {
                if (!selectedKeyForAction || !oldPassword || !newPassword) {
                    onNotification('error', 'Please fill all password fields');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    onNotification('error', 'New passwords do not match');
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/change-key-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            key_id: selectedKeyForAction,
                            old_password: oldPassword,
                            new_password: newPassword
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        onNotification('success', 'Password changed successfully');
                        setShowPasswordModal(false);
                        setOldPassword('');
                        setNewPassword('');
                        setConfirmPassword('');
                        onKeyUpdated();
                    } else {
                        onNotification('error', result.error || 'Failed to change password');
                    }
                } catch (error) {
                    onNotification('error', 'Network error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">üîë Key Management</h2>
                    
                    {Object.keys(keys).length === 0 ? (
                        <p className="text-gray-500 text-center py-8">No keys generated yet</p>
                    ) : (
                        <div className="space-y-3">
                            {Object.entries(keys).map(([keyId, keyData]) => (
                                <div key={keyId} className="border border-gray-200 rounded-lg p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <h3 className="font-medium text-gray-800 flex items-center gap-2">
                                                {keyId}
                                                {keyData.encrypted ? (
                                                    <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">üîí Encrypted</span>
                                                ) : (
                                                    <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">üîì Unencrypted</span>
                                                )}
                                            </h3>
                                            <p className="text-sm text-gray-500">
                                                Created: {new Date(keyData.created_at).toLocaleString()}
                                            </p>
                                            {keyData.encrypted && (
                                                <p className="text-xs text-gray-500">
                                                    {keyData.encryption_algorithm} ‚Ä¢ {keyData.kdf}
                                                </p>
                                            )}
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => {
                                                    setSelectedKeyForAction(keyId);
                                                    setShowExportModal(true);
                                                }}
                                                className="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors"
                                            >
                                                Export
                                            </button>
                                            {keyData.encrypted && (
                                                <button
                                                    onClick={() => {
                                                        setSelectedKeyForAction(keyId);
                                                        setShowPasswordModal(true);
                                                    }}
                                                    className="text-sm bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600 transition-colors"
                                                >
                                                    Change Password
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Export Modal */}
                    {showExportModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                                <h3 className="text-lg font-bold mb-4">Export Key: {selectedKeyForAction}</h3>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Export Format</label>
                                        <select
                                            value={exportFormat}
                                            onChange={(e) => setExportFormat(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                        >
                                            <option value="pem">PEM (requires password for encrypted keys)</option>
                                            <option value="encrypted">Encrypted Format</option>
                                        </select>
                                    </div>

                                    {exportFormat === 'pem' && keys[selectedKeyForAction]?.encrypted && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Key Password</label>
                                            <input
                                                type="password"
                                                value={exportPassword}
                                                onChange={(e) => setExportPassword(e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                placeholder="Enter key password"
                                            />
                                        </div>
                                    )}

                                    <div className="flex gap-3">
                                        <button
                                            onClick={exportKey}
                                            disabled={loading}
                                            className="flex-1 bg-primary text-white py-2 rounded-lg hover:bg-secondary transition-colors disabled:opacity-50"
                                        >
                                            {loading ? 'Exporting...' : 'Export'}
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowExportModal(false);
                                                setExportPassword('');
                                            }}
                                            className="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-colors"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Password Change Modal */}
                    {showPasswordModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                                <h3 className="text-lg font-bold mb-4">Change Password: {selectedKeyForAction}</h3>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                                        <input
                                            type="password"
                                            value={oldPassword}
                                            onChange={(e) => setOldPassword(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                            placeholder="Enter current password"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                        <input
                                            type="password"
                                            value={newPassword}
                                            onChange={(e) => setNewPassword(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                            placeholder="Enter new password"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                                        <input
                                            type="password"
                                            value={confirmPassword}
                                            onChange={(e) => setConfirmPassword(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                            placeholder="Confirm new password"
                                        />
                                    </div>

                                    <div className="flex gap-3">
                                        <button
                                            onClick={changePassword}
                                            disabled={loading}
                                            className="flex-1 bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition-colors disabled:opacity-50"
                                        >
                                            {loading ? 'Changing...' : 'Change Password'}
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowPasswordModal(false);
                                                setOldPassword('');
                                                setNewPassword('');
                                                setConfirmPassword('');
                                            }}
                                            className="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-colors"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // System Status Component
        const SystemStatus = ({ keys, signatures, serverInfo }) => {
            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">üìä System Status</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-blue-50 p-4 rounded-lg text-center">
                            <div className="text-2xl font-bold text-blue-600">{Object.keys(keys).length}</div>
                            <div className="text-sm text-blue-800">Total Keys</div>
                        </div>
                        
                        <div className="bg-green-50 p-4 rounded-lg text-center">
                            <div className="text-2xl font-bold text-green-600">{Object.keys(signatures).length}</div>
                            <div className="text-sm text-green-800">Total Signatures</div>
                        </div>
                        
                        <div className="bg-purple-50 p-4 rounded-lg text-center">
                            <div className="text-2xl font-bold text-purple-600">
                                {Object.values(keys).filter(k => k.encrypted).length}
                            </div>
                            <div className="text-sm text-purple-800">Encrypted Keys</div>
                        </div>
                    </div>

                    {serverInfo && (
                        <div className="mt-6">
                            <h3 className="font-medium text-gray-800 mb-3">Security Features</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                <div className="flex justify-between">
                                    <span>Private Key Encryption:</span>
                                    <span className="font-medium">{serverInfo.security_features?.private_key_encryption}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>Key Derivation:</span>
                                    <span className="font-medium">{serverInfo.security_features?.key_derivation}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>Elliptic Curve:</span>
                                    <span className="font-medium">{serverInfo.security_features?.elliptic_curve}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>Hash Algorithm:</span>
                                    <span className="font-medium">{serverInfo.security_features?.hash_algorithm}</span>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [activeTab, setActiveTab] = useState('generate');
            const [keys, setKeys] = useState({});
            const [signatures, setSignatures] = useState({});
            const [serverInfo, setServerInfo] = useState(null);
            const [notifications, setNotifications] = useState([]);
            const [serverStatus, setServerStatus] = useState('checking');

            const addNotification = (type, message) => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, type, message }]);
            };

            const removeNotification = (id) => {
                setNotifications(prev => prev.filter(n => n.id !== id));
            };

            const fetchKeys = async () => {
                try {
                    const response = await fetch(`${API_BASE}/keys`);
                    const result = await response.json();
                    if (result.success) {
                        setKeys(result.keys);
                    }
                } catch (error) {
                    console.error('Failed to fetch keys:', error);
                }
            };

            const fetchSignatures = async () => {
                try {
                    const response = await fetch(`${API_BASE}/signatures`);
                    const result = await response.json();
                    if (result.success) {
                        setSignatures(result.signatures);
                    }
                } catch (error) {
                    console.error('Failed to fetch signatures:', error);
                }
            };

            const checkServerStatus = async () => {
                try {
                    const response = await fetch(`${API_BASE}/health`);
                    if (response.ok) {
                        setServerStatus('online');
                        const serverResponse = await fetch(`${API_BASE}/`);
                        const serverData = await serverResponse.json();
                        setServerInfo(serverData);
                    } else {
                        setServerStatus('error');
                    }
                } catch (error) {
                    setServerStatus('offline');
                }
            };

            useEffect(() => {
                checkServerStatus();
                fetchKeys();
                fetchSignatures();
                
                const interval = setInterval(() => {
                    checkServerStatus();
                    fetchKeys();
                    fetchSignatures();
                }, 30000); // Refresh every 30 seconds
                
                return () => clearInterval(interval);
            }, []);

            const tabs = [
                { id: 'generate', label: 'Generate Keys', icon: 'üîë' },
                { id: 'sign', label: 'Sign File', icon: '‚úçÔ∏è' },
                { id: 'verify', label: 'Verify Signature', icon: '‚úÖ' },
                { id: 'patch', label: 'Patch Binary', icon: 'üîß' },
                { id: 'verify-patched', label: 'Verify Patched', icon: 'üîç' },
                { id: 'keys', label: 'Manage Keys', icon: 'üîê' },
                { id: 'status', label: 'System Status', icon: 'üìä' }
            ];

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Notifications */}
                    {notifications.map(notification => (
                        <Notification
                            key={notification.id}
                            type={notification.type}
                            message={notification.message}
                            onClose={() => removeNotification(notification.id)}
                        />
                    ))}

                    {/* Header */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <div className="flex items-center">
                                    <h1 className="text-2xl font-bold text-gray-900">üîê ECC Digital Signing System</h1>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <div className={`flex items-center space-x-2 text-sm ${
                                        serverStatus === 'online' ? 'text-green-600' : 
                                        serverStatus === 'offline' ? 'text-red-600' : 'text-yellow-600'
                                    }`}>
                                        <div className={`w-2 h-2 rounded-full ${
                                            serverStatus === 'online' ? 'bg-green-500' : 
                                            serverStatus === 'offline' ? 'bg-red-500' : 'bg-yellow-500'
                                        }`}></div>
                                        <span>
                                            {serverStatus === 'online' ? 'Server Online' : 
                                             serverStatus === 'offline' ? 'Server Offline' : 'Checking...'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Server Offline Warning */}
                    {serverStatus === 'offline' && (
                        <div className="bg-red-50 border-l-4 border-red-400 p-4">
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div className="flex">
                                    <div className="ml-3">
                                        <p className="text-sm text-red-700">
                                            ‚ö†Ô∏è Server is offline. Please start the backend server with: <code className="bg-red-100 px-1 rounded">uv run main.py</code>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Navigation Tabs */}
                    <nav className="bg-white border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex space-x-8 overflow-x-auto">
                                {tabs.map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${
                                            activeTab === tab.id
                                                ? 'border-primary text-primary'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <span className="mr-2">{tab.icon}</span>
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {activeTab === 'generate' && (
                                <>
                                    <KeyGeneration 
                                        onNotification={addNotification} 
                                        onKeyGenerated={fetchKeys}
                                    />
                                    <div className="bg-white p-6 rounded-lg shadow-md">
                                        <h3 className="text-lg font-bold mb-4">About Key Generation</h3>
                                        <div className="space-y-3 text-sm text-gray-600">
                                            <p>üîê <strong>Encrypted Keys:</strong> Private keys are encrypted using AES-256-GCM with password-based key derivation (PBKDF2-SHA256, 100,000 iterations).</p>
                                            <p>üîì <strong>Unencrypted Keys:</strong> Private keys are stored in plain text (not recommended for production).</p>
                                            <p>üîë <strong>Algorithm:</strong> ECDSA with SECP256k1 curve (Bitcoin standard).</p>
                                            <p>üíæ <strong>Storage:</strong> Keys are permanently saved to disk for reuse.</p>
                                        </div>
                                    </div>
                                </>
                            )}

                            {activeTab === 'sign' && (
                                <>
                                    <FileSigning 
                                        keys={keys} 
                                        onNotification={addNotification}
                                    />
                                    <div className="bg-white p-6 rounded-lg shadow-md">
                                        <h3 className="text-lg font-bold mb-4">About File Signing</h3>
                                        <div className="space-y-3 text-sm text-gray-600">
                                            <p>‚úçÔ∏è <strong>Digital Signature:</strong> Creates an ECDSA signature of the file's SHA-256 hash.</p>
                                            <p>üìÑ <strong>Signature File:</strong> Downloads a .sig file containing signature metadata.</p>
                                            <p>üîí <strong>Encrypted Keys:</strong> Requires password input for encrypted private keys.</p>
                                            <p>üïê <strong>Timestamp:</strong> Each signature includes creation timestamp for auditing.</p>
                                        </div>
                                    </div>
                                </>
                            )}

                            {activeTab === 'verify' && (
                                <>
                                    <FileVerification 
                                        keys={keys} 
                                        onNotification={addNotification}
                                    />
                                    <div className="bg-white p-6 rounded-lg shadow-md">
                                        <h3 className="text-lg font-bold mb-4">About Signature Verification</h3>
                                        <div className="space-y-3 text-sm text-gray-600">
                                            <p>‚úÖ <strong>Integrity Check:</strong> Verifies the file hasn't been modified since signing.</p>
                                            <p>üîç <strong>Authenticity:</strong> Confirms the signature was created with the specified private key.</p>
                                            <p>üìã <strong>Signature Files:</strong> Upload .sig files generated during signing.</p>
                                            <p>üéØ <strong>Auto-detection:</strong> Key ID can be automatically detected from signature metadata.</p>
                                        </div>
                                    </div>
                                </>
                            )}

                            {activeTab === 'patch' && (
                                <>
                                    <BinaryPatching 
                                        keys={keys} 
                                        onNotification={addNotification}
                                    />
                                    <div className="bg-white p-6 rounded-lg shadow-md">
                                        <h3 className="text-lg font-bold mb-4">About Binary Patching</h3>
                                        <div className="space-y-3 text-sm text-gray-600">
                                            <p>üîß <strong>Embedded Signature:</strong> Appends signature data directly to the file.</p>
                                            <p>üì¶ <strong>Self-contained:</strong> No separate signature file needed for verification.</p>
                                            <p>‚ö° <strong>Convenient:</strong> Single file contains both data and signature.</p>
                                            <p>üìä <strong>Overhead:</strong> Adds signature metadata to the file size.</p>
                                        </div>
                                    </div>
                                </>
                            )}

                            {activeTab === 'verify-patched' && (
                                <>
                                    <PatchedBinaryVerification 
                                        onNotification={addNotification}
                                    />
                                    <div className="bg-white p-6 rounded-lg shadow-md">
                                        <h3 className="text-lg font-bold mb-4">About Patched Binary Verification</h3>
                                        <div className="space-y-3 text-sm text-gray-600">
                                            <p>üîç <strong>Self-verification:</strong> Extracts and verifies embedded signature.</p>
                                            <p>üìã <strong>Metadata Display:</strong> Shows signature algorithm, key ID, and timestamp.</p>
                                            <p>üìä <strong>Size Analysis:</strong> Displays original vs patched file sizes.</p>
                                            <p>üõ°Ô∏è <strong>Integrity:</strong> Confirms both file authenticity and signature validity.</p>
                                        </div>
                                    </div>
                                </>
                            )}

                            {activeTab === 'keys' && (
                                <div className="lg:col-span-2">
                                    <KeyManagement 
                                        keys={keys} 
                                        onKeyUpdated={fetchKeys}
                                        onNotification={addNotification}
                                    />
                                </div>
                            )}

                            {activeTab === 'status' && (
                                <div className="lg:col-span-2">
                                    <SystemStatus 
                                        keys={keys} 
                                        signatures={signatures}
                                        serverInfo={serverInfo}
                                    />
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Footer */}
                    <footer className="bg-white border-t border-gray-200 mt-12">
                        <div className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                            <div className="text-center text-sm text-gray-500">
                                <p>ECC Digital Signing System - Kelompok 1 - Kriptografi (B)</p>
                                <p className="mt-1">Secure digital signatures using ECDSA-SECP256k1 with AES-256-GCM encrypted key storage</p>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
